var fixedRate,remotePostcodes=[],postcodeEntries=[],maxBorrow=6e4,loanAmountThreshhold=3e4,borrowingLoanTermErrorMessageObj=$("#BorrowLoanTermDropdownError"),repaymentLoanTermErrorMessageObj=$("#RepaymentLoanTermDropdownError"),borrowingPowerAmountObj=$("#BorrowingPower"),borrowingPowerErrorMessageObj=$("#BorrowingPowerErrorMessage"),monthlyRepaymentAmountObj=$("#MonthlyRepayment"),monthlyRepaymentErrorMessageObj=$("#MonthlyRepaymentErrorMessage"),showLoanTermErrorMessage=0,showLoanTermErrorMessage2=0,repaymentLoanAmountErrorMessageObj=$("#RepaymentCalcLoanAmountError"),apiError=!1;function roundTo(e,r){var o=!1;void 0===r&&(r=0),e<0&&(o=!0,e*=-1);var a=Math.pow(10,r);return e=parseFloat((e*a).toFixed(11)),e=(Math.round(e)/a).toFixed(r),o&&(e=(-1*e).toFixed(r)),e}function getNewRate(){var e=$(".rate_FIXED_PERSONAL_LOAN_InterestRate").first().text();return""!==e&&0!==e&&null!==e||(e=!1),e}function drawLoanTermDropdown(e,r){var o=$("#"+e);if(o.length){for(var a="",t=2;t<=r;t++)a+='<li><a href="javascript:;" class="dropdown-option" data-value="'+t+'">'+t+" years</a></li>";o.html(a)}}function resetLoanTermDropdown(e,r){var o=r+" year";1<r&&(o+="s"),r||(o="Please select"),$("#"+e).closest(".dropdown").find(".dropdown-toggle").text(o),$("#"+e).data("value",r)}function PMT(e,r,o,a,t){var n,s;return a=a||0,t=t||0,0===e?-(o+a)/r:(n=-e*o*((s=Math.pow(1+e,r))+a)/(s-1),1===t&&(n/=1+e),n)}function getSanitised(e,r){var o=e.replace(/[^\d]/g,"").substring(0,r);return(0===parseInt(o)?"0":parseInt(o))||""}function checkNumberLen(e,r){return e.replace(/[^\d]/g,"").substring(0,r)}$.ajax({method:"POST",url:"https://campaigns.staging.ing.com.au/Resource/api/PersonalLoan/GetHemData",beforeSend:function(){$("#BorrowingPowerCalc .api-loader").removeClass("hide")},success:function(e){remotePostcodes=e.RemotePostcodes,postcodeEntries=e.PostcodeEntries},error:function(e){apiError=!0,console.log(e),$("#BorrowingPowerCalc .api-loader").find(".loader-spinner").remove();$("#BorrowingPowerCalc .api-loader").append('<div class="error"><strong>ERROR:</strong> Something went wrong. Please reload the page to try again.</div>')},complete:function(){var e=setInterval(function(){fixedRate=getNewRate(),!apiError&&fixedRate&&(clearInterval(e),$("#BorrowingPowerCalc .api-loader").remove())},500)}}),$(".dropdown").on("click",".dropdown-option",function(){var e=$(this).text(),r=$(this).data("value");$(this).closest(".dropdown").find(".dropdown-toggle").text(e),$(this).closest(".dropdown-menu").data("value",r).trigger("change")}),$(".currency-validate").on("input",function(e){var r=getSanitised($(e.target).val(),9);$(e.target).val("$"+r.toString().replace(/\d(?=(\d{3})+$)/g,"$&,"))}),$(".number-validate").on("input",function(e){var r=$(this).data("digits"),o=getSanitised($(e.target).val(),r);$(e.target).val(o.toString().replace(/\d(?=(\d{3})+$)/g,"$&,"))}),$(".postcode-validate").on("input",function(e){var r=checkNumberLen($(e.target).val(),4);$(e.target).val(r)}),function borrowingPowerCalculator(e){if($("#BorrowingPowerCalc").length){var relationship="s",dependents=0,postcode="",grossSalary=0,otherIncome=0,livingExpenses=0,rentMortgage=0,rentMortgageFinal=0,otherLoans=0,creditLimit=0,loanLimitConsol=0,cardLimitConsol=0,loanTerm=0;$("#BorrowingPowerCalc").on("input change",function(e){switch($(e.target).attr("name")){case"dependents":var value=getSanitised($(e.target).val(),2);dependents=parseInt(value)||0;break;case"postcode":var value=getSanitised($(e.target).val(),4);postcode=value.toString()||"";break;case"gross-salary":var amount=getSanitised($(e.target).val(),9);grossSalary=parseInt(amount)||0;break;case"other-income":var amount=getSanitised($(e.target).val(),9);otherIncome=parseInt(amount)||0;break;case"living-expenses":var amount=getSanitised($(e.target).val(),9);livingExpenses=parseInt(amount)||0;break;case"rent-mortgage":var amount=getSanitised($(e.target).val(),9);rentMortgage=parseInt(amount)||0;break;case"other-loans":var amount=getSanitised($(e.target).val(),9);otherLoans=parseInt(amount)||0;break;case"credit-limit":var amount=getSanitised($(e.target).val(),9);creditLimit=parseInt(amount)||0;break;case"loan-limit-consol":var amount=getSanitised($(e.target).val(),9);loanLimitConsol=parseInt(amount)||0;break;case"card-limit-consol":var amount=getSanitised($(e.target).val(),9);cardLimitConsol=parseInt(amount)||0;break;case"loan-term":loanTerm=parseInt($(e.target).data("value"))||0}var medicare=0,totalTaxableIncome=0,totalIncomeTax=0,postTaxIncome=0,expenseOtherLoan=0,expenseMortgage=0,expenseCreditCardLimit=0,applicatantDependenntFee=0,finalLivingExpense=0,totalCommitmentExpense=0,totalConsolidation=0,income=12*grossSalary+12*otherIncome*65/100;CalculateTax(),CalculateRentMortgage(),CalculateHemLivingExpense(),CalculateOtherExpense(),CalculateConsolidateBenefit();var surplus=postTaxIncome-totalCommitmentExpense+totalConsolidation,borrowCap1Test=totalTaxableIncome/12*6,borrowCap2Test=6e4-expenseCreditCardLimit,borrowCap3Test=pv(fixedRate/100,60,-surplus/12,0),borrowPowerTest=0;3e3<=grossSalary&&(borrowPowerTest=Math.min(maxBorrow,borrowCap1Test,borrowCap2Test,borrowCap3Test)),borrowPowerTest=500*Math.floor(borrowPowerTest/500),drawLoanTermDropdown("BorrowLoanTermDropdown",loanAmountThreshhold<borrowPowerTest?7:5);var borrowCap1=totalTaxableIncome/12*6,borrowCap2=6e4-expenseCreditCardLimit,borrowCap3=pv(fixedRate/100,12*loanTerm,-surplus/12,0),borrowPower=0;3e3<=grossSalary&&(borrowPower=Math.min(maxBorrow,borrowCap1,borrowCap2,borrowCap3)),borrowPower=500*Math.floor(borrowPower/500),5<loanTerm&&borrowPower<=loanAmountThreshhold?(resetLoanTermDropdown("BorrowLoanTermDropdown",5),loanTerm=5,borrowingLoanTermErrorMessageObj.addClass("in"),showLoanTermErrorMessage=1):1<showLoanTermErrorMessage?(borrowingLoanTermErrorMessageObj.removeClass("in"),showLoanTermErrorMessage=0):showLoanTermErrorMessage++;var repayment=-1*PMT(fixedRate/100/12,12*loanTerm,borrowPower).toFixed(2);function CalculateTax(){var e=0,r=0,o=0,a=0,t=0;income<18200?e=income:(e=18200,income<37e3?r=income-e:(r=18800,income<87e3?o=income-e-r:(o=5e4,income<18e4?a=income-e-r-o:t=income-e-r-o-(a=93e3)))),medicare=.02*income,totalIncomeTax=0*e+.19*r+.325*o+.37*a+.45*t,(totalTaxableIncome=e+r+o+a+t)!=income&&console.log("Error!"),postTaxIncome=income-(totalIncomeTax+medicare)}function CalculateRentMortgage(){var e=0===dependents?9100/12:13e3/12;rentMortgageFinal=rentMortgage<e?e:rentMortgage}function getHem(){var e="s"!==relationship,r=0,o=0,a=0,t=!0,n=-1!==remotePostcodes.indexOf(postcode);for(i=0;i<postcodeEntries.length;i++){var s=postcodeEntries[i];if(s.IsRemote===n)for(j=0;j<s.Categories.length;j++){var m=s.Categories[j];if(income>=m.From&&income<m.To)for(t=!1,a=(m.From+m.To)/2,k=0;k<m.MaritalEntries.length;k++){if((d=m.MaritalEntries[k]).IsCouple===e)for(l=0;l<d.Dependents.length;l++){(p=d.Dependents[l]).No<=dependents&&(o=p.Value)}}if(j==s.Categories.length-2&&t)for(k=0;k<m.MaritalEntries.length;k++){if((d=m.MaritalEntries[k]).IsCouple===e)for(l=0;l<d.Dependents.length;l++){(p=d.Dependents[l]).No<=dependents&&(r=p.Value)}}if(j==s.Categories.length-1&&t)for(a=Math.ceil((m.From+m.To)/2),k=0;k<m.MaritalEntries.length;k++){var d;if((d=m.MaritalEntries[k]).IsCouple===e)for(l=0;l<d.Dependents.length;l++){var p;(p=d.Dependents[l]).No<=dependents&&(o=p.Value)}}}}return t&&(o=income/a*(o-r)+r),o=roundTo(o,2)}function CalculateHemLivingExpense(){var e=52*getHem();finalLivingExpense=e<12*livingExpenses?12*livingExpenses:e}function CalculateConsolidateBenefit(){var e=PMT(.1/12,84,loanLimitConsol),r=.038*cardLimitConsol*-1,o=1*Math.abs(12*e+12*r).toFixed(2);totalConsolidation=0<o?o:0}function CalculateOtherExpense(){totalCommitmentExpense=(expenseOtherLoan=12*otherLoans)+(expenseMortgage=12*rentMortgageFinal)+(expenseCreditCardLimit=.038*creditLimit*12)+finalLivingExpense}function conv_number(expr,decplaces){for(var str=""+Math.round(eval(expr)*Math.pow(10,decplaces));str.length<=decplaces;)str="0"+str;var decpoint=str.length-decplaces;return str.substring(0,decpoint)+"."+str.substring(decpoint,str.length)}function pv(e,r,o,a){return r=parseFloat(r),o=parseFloat(o),a=parseFloat(a),0===o||0===r?0:(0==(e/=12)?pv_value=-(a+o*r):(x=Math.pow(1+e,-r),y=Math.pow(1+e,r),pv_value=-x*(a*e-o+y*o)/e),pv_value=conv_number(pv_value,2),pv_value)}borrowingPowerErrorMessageObj.addClass("hide"),monthlyRepaymentErrorMessageObj.addClass("hide"),borrowingPowerAmountObj.removeClass("hide"),monthlyRepaymentAmountObj.removeClass("hide"),borrowPower<=0||repayment<=0||!postcode?($("#borrowing-power").text("-"),$("#monthly-repayments").text("-"),0<grossSalary&&0<loanTerm&&(borrowingPowerErrorMessageObj.removeClass("hide"),monthlyRepaymentErrorMessageObj.removeClass("hide"),borrowingPowerAmountObj.addClass("hide"),monthlyRepaymentAmountObj.addClass("hide"))):($("#borrowing-power").text(Math.round(borrowPower).toString().replace(/\d(?=(\d{3})+$)/g,"$&,")),$("#monthly-repayments").text(Math.round(repayment)))})}}(),function(){if($("#repayments-calc").length){var o=0,a=0,t="-",n="-",s=$("#monthly-repayment"),i=$("#fortnight-repayment");$("#repayments-calc").on("input change",function(e){switch($(e.target).attr("name")){case"loan-amount":var r=getSanitised($(e.target).val(),9);o=parseInt(r)||0;break;case"loan-term":a=parseInt($(e.target).data("value"))||0}o<5e3||maxBorrow<o?(repaymentLoanAmountErrorMessageObj.removeClass("hide"),$("#drop3").addClass("disabled"),resetLoanTermDropdown("RepaymentLoanTermDropdown",null),repaymentLoanTermErrorMessageObj.removeClass("in"),a=0):(repaymentLoanAmountErrorMessageObj.addClass("hide"),loanAmountThreshhold<o?(drawLoanTermDropdown("RepaymentLoanTermDropdown",7),repaymentLoanTermErrorMessageObj.removeClass("in"),showLoanTermErrorMessage2=0):(drawLoanTermDropdown("RepaymentLoanTermDropdown",5),5<a?(resetLoanTermDropdown("RepaymentLoanTermDropdown",5),a=5,repaymentLoanTermErrorMessageObj.addClass("in"),showLoanTermErrorMessage2=1):1<showLoanTermErrorMessage2?(repaymentLoanTermErrorMessageObj.removeClass("in"),showLoanTermErrorMessage2=0):showLoanTermErrorMessage2++),console.log("Loan Term Error Num: "+showLoanTermErrorMessage2),$("#drop3").removeClass("disabled")),n=0==a?t="-":5e3<=o&&o<=maxBorrow?o<=loanAmountThreshhold&&5<a?(console.log("ERROR: 6 and 7 year repayment terms are only available for loans over $30,000"),t="-"):(t=-1*Math.round(PMT(fixedRate/100/12,12*a,o)),-1*Math.round(PMT(fixedRate/100/26,26*a,o))):t="-",s.text(t),i.text(n)})}}();